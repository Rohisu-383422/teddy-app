<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teddy - Interactive Polling</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <!-- lucide-react workaround -->
    <script>window.react = window.React;</script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase -->
    <script type="importmap">
      {
        "imports": {
          "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
          "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
          "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
      }
    </script>
</head>
<body class="bg-slate-50 text-slate-800 font-sans">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp, getApps, getApp } from "firebase/app";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove, increment, deleteField, collection } from "firebase/firestore";

        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- Icon Setup ---
        const createLucideIcon = (iconName, content) => {
          return React.forwardRef((props, ref) => {
            const { color = 'currentColor', size = 24, strokeWidth = 2, className = '', ...rest } = props;
            return React.createElement('svg', { ref, xmlns: 'http://www.w3.org/2000/svg', width: size, height: size, viewBox: '0 0 24 24', fill: 'none', stroke: color, strokeWidth: strokeWidth, strokeLinecap: 'round', strokeLinejoin: 'round', className: `lucide lucide-${iconName} ${className}`, ...rest, dangerouslySetInnerHTML: { __html: content } });
          });
        };

        const icons = {};
        if (window.lucide && window.lucide.icons) {
           Object.entries(window.lucide.icons).forEach(([name, data]) => {
              const pascalName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
              const content = data.map(([tag, attrs]) => { const attrStr = Object.entries(attrs).map(([k, v]) => `${k}="${v}"`).join(' '); return `<${tag} ${attrStr}></${tag}>`; }).join('');
              icons[pascalName] = createLucideIcon(name, content);
           });
        }
        const FallbackIcon = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="m9 9 6 6"/><path d="m15 9-6 6"/></svg>;
        const getIcon = (name) => icons[name] || FallbackIcon;

        const BarChart3 = getIcon('BarChart3'); const PieChart = getIcon('PieChart'); const Type = getIcon('Type'); const Smartphone = getIcon('Smartphone'); const Monitor = getIcon('Monitor'); const Settings = getIcon('Settings'); const Send = getIcon('Send'); const Users = getIcon('Users'); const MessageSquare = getIcon('MessageSquare'); const ThumbsUp = getIcon('ThumbsUp'); const Heart = getIcon('Heart'); const Smile = getIcon('Smile'); const RefreshCw = getIcon('RefreshCw'); const LayoutTemplate = getIcon('LayoutTemplate'); const Plus = getIcon('Plus'); const Trash2 = getIcon('Trash2'); const X = getIcon('X'); const SaveIcon = getIcon('Save'); const Trophy = getIcon('Trophy'); const ListOrdered = getIcon('ListOrdered'); const ImageIcon = getIcon('Image'); const Upload = getIcon('Upload'); const LogOut = getIcon('LogOut'); const Copy = getIcon('Copy'); const ExternalLink = getIcon('ExternalLink'); const Play = getIcon('Play'); const Edit3 = getIcon('Edit3'); const Eye = getIcon('Eye'); const EyeOff = getIcon('EyeOff'); const RotateCcw = getIcon('RotateCcw'); const Lock = getIcon('Lock'); const Unlock = getIcon('Unlock'); const TimerIcon = getIcon('Timer'); const Download = getIcon('Download'); const Maximize2 = getIcon('Maximize2'); const User = getIcon('User'); const MoreVertical = getIcon('MoreVertical'); const CheckCircle = getIcon('CheckCircle'); const AlertCircle = getIcon('AlertCircle'); const Minimize2 = getIcon('Minimize2'); const ArrowUp = getIcon('ArrowUp'); const ArrowDown = getIcon('ArrowDown'); const Keyboard = getIcon('Keyboard'); const Volume2 = getIcon('Volume2'); const VolumeX = getIcon('VolumeX'); const DuplicateIcon = getIcon('Copy'); const HelpCircle = getIcon('HelpCircle'); const Check = getIcon('Check'); const FileSpreadsheet = getIcon('FileSpreadsheet'); const FileText = getIcon('FileText'); const Award = getIcon('Award'); const FileJson = getIcon('FileJson'); const FolderInput = getIcon('FolderInput'); const StickyNote = getIcon('StickyNote'); const Palette = getIcon('Palette');

        // --- Constants & Utilities ---
        const COLLECTION_NAME = 'sessions';

        const COLORS = ['bg-blue-500', 'bg-red-500', 'bg-yellow-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 'bg-indigo-500', 'bg-teal-500'];
        const TEXT_COLORS = ['text-blue-600', 'text-red-600', 'text-yellow-600', 'text-green-600', 'text-purple-600', 'text-pink-600', 'text-indigo-600', 'text-teal-600'];

        const THEMES = {
          indigo: { name: 'Indigo', bg: 'bg-indigo-600', bgHover: 'hover:bg-indigo-700', text: 'text-indigo-600', textHover: 'hover:text-indigo-700', light: 'bg-indigo-50', lightHover: 'hover:bg-indigo-100', border: 'border-indigo-200', ring: 'focus:ring-indigo-500', fill: 'fill-indigo-100', stroke: 'stroke-indigo-600' },
          rose: { name: 'Rose', bg: 'bg-rose-600', bgHover: 'hover:bg-rose-700', text: 'text-rose-600', textHover: 'hover:text-rose-700', light: 'bg-rose-50', lightHover: 'hover:bg-rose-100', border: 'border-rose-200', ring: 'focus:ring-rose-500', fill: 'fill-rose-100', stroke: 'stroke-rose-600' },
          emerald: { name: 'Emerald', bg: 'bg-emerald-600', bgHover: 'hover:bg-emerald-700', text: 'text-emerald-600', textHover: 'hover:text-emerald-700', light: 'bg-emerald-50', lightHover: 'hover:bg-emerald-100', border: 'border-emerald-200', ring: 'focus:ring-emerald-500', fill: 'fill-emerald-100', stroke: 'stroke-emerald-600' },
          amber: { name: 'Amber', bg: 'bg-amber-600', bgHover: 'hover:bg-amber-700', text: 'text-amber-600', textHover: 'hover:text-amber-700', light: 'bg-amber-50', lightHover: 'hover:bg-amber-100', border: 'border-amber-200', ring: 'focus:ring-amber-500', fill: 'fill-amber-100', stroke: 'stroke-amber-600' },
          sky: { name: 'Sky', bg: 'bg-sky-600', bgHover: 'hover:bg-sky-700', text: 'text-sky-600', textHover: 'hover:text-sky-700', light: 'bg-sky-50', lightHover: 'hover:bg-sky-100', border: 'border-sky-200', ring: 'focus:ring-sky-500', fill: 'fill-sky-100', stroke: 'stroke-sky-600' },
        };

        const generateRoomId = () => Math.floor(100000 + Math.random() * 900000).toString();
        const calculateTotalVotes = (question) => {
          if (!question || !question.votes) return 0;
          if (question.type === 'wordcloud' || question.type === 'open') return Array.isArray(question.votes) ? question.votes.length : 0;
          if (question.type === 'qa') return Object.keys(question.votes || {}).length;
          if (question.type === 'content') return 0;
          return Object.values(question.votes).reduce((a, b) => a + b, 0);
        };
        const resizeImage = (file, maxWidth = 800, quality = 0.7) => {
          return new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (event) => {
              const img = new Image(); img.src = event.target.result;
              img.onload = () => {
                const canvas = document.createElement('canvas'); let width = img.width; let height = img.height;
                if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxWidth) { width *= maxWidth / height; height = maxWidth; } }
                canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); if (ctx) ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', quality));
              }; img.onerror = (error) => reject(error);
            }; reader.onerror = (error) => reject(error);
          });
        };
        const playSound = (type) => {
          try {
            const AudioContext = window.AudioContext || window.webkitAudioContext; if (!AudioContext) return; const ctx = new AudioContext();
            if (ctx.state === 'suspended') { ctx.resume().catch(() => {}); }
            const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); const now = ctx.currentTime;
            if (type === 'tick') { osc.type = 'sine'; osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1); osc.start(now); osc.stop(now + 0.1); } 
            else if (type === 'end') { osc.type = 'square'; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(200, now + 0.5); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.5); osc.start(now); osc.stop(now + 0.5); } 
            else if (type === 'pop') { osc.frequency.setValueAtTime(400, now); osc.frequency.exponentialRampToValueAtTime(800, now + 0.1); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); } 
            else if (type === 'correct') { osc.type = 'triangle'; osc.frequency.setValueAtTime(660, now); osc.frequency.setValueAtTime(880, now + 0.1); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
          } catch (e) { console.log("Audio play blocked by browser policy"); }
        };

        const INITIAL_QUESTIONS_TEMPLATE = { '1': { id: '1', type: 'choice', question: 'ä»Šã®æ°—åˆ†ã¯ã©ã†ã§ã™ã‹ï¼Ÿ', options: ['çµ¶å¥½èª¿ï¼', 'ã¾ã‚ã¾ã‚', 'çœ ã„...', 'ãŠè…¹ã™ã„ãŸ'], votes: { 'çµ¶å¥½èª¿ï¼': 0, 'ã¾ã‚ã¾ã‚': 0, 'çœ ã„...': 0, 'ãŠè…¹ã™ã„ãŸ': 0 }, allowedVisuals: ['bar', 'donut'], image: null, isLocked: false, timerEndsAt: null, order: 0, correctOption: null, isAnswerRevealed: false, notes: "" } };

        const TeddyIcon = ({ size = 24, className }) => (
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="5" cy="7" r="2.5" /><circle cx="19" cy="7" r="2.5" /><path d="M12 21c5 0 9-3.5 9-9 0-4-3-8-9-8s-9 4-9 8c0 5.5 4 9 9 9z" /><path d="M5 7c0 .5-.2 1-.5 1" /><path d="M19 7c0 .5.2 1 .5 1" /><circle cx="9" cy="11" r="1" fill="currentColor" stroke="none"/><circle cx="15" cy="11" r="1" fill="currentColor" stroke="none"/><ellipse cx="12" cy="15" rx="3" ry="2.5" /><path d="M12 14v1.5" /><path d="M11 16.5h2" /></svg>
        );

        const AppLogo = ({ customSrc, size = 40, className, onUpload, editable = false }) => {
          const fileInputRef = useRef(null); const imgSrc = (typeof customSrc === 'string' && customSrc.startsWith('data:')) ? customSrc : null;
          const handleFileChange = async (e) => { const file = e.target.files[0]; if (file && onUpload) { try { const resizedImage = await resizeImage(file, 200, 0.7); onUpload(resizedImage); } catch (error) { alert("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ"); } } };
          return (
            <div className={`relative flex items-center justify-center group ${editable ? 'cursor-pointer' : ''}`} onClick={() => editable && fileInputRef.current?.click()} title={editable ? "ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ­ã‚´ã‚’å¤‰æ›´" : ""}>
              {imgSrc ? <img src={imgSrc} alt="App Logo" style={{ width: size, height: size, objectFit: 'contain' }} className={`rounded-full ${className}`} /> : <TeddyIcon size={size} className={className} />}
              {editable && <><div className="absolute -bottom-1 -right-1 bg-white rounded-full p-1 shadow-sm border border-slate-200 opacity-0 group-hover:opacity-100 transition-opacity"><Edit3 size={12} className="text-slate-500" /></div><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange} /></>}
            </div>
          );
        };

        const ToastContainer = ({ toasts }) => {
          return (
            <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2 items-center pointer-events-none w-full max-w-sm px-4">
              {toasts.map((t) => (
                <div key={t.id} className={`flex items-center gap-2 px-4 py-3 rounded-full shadow-lg font-bold text-sm animate-in slide-in-from-bottom-5 fade-in duration-300 ${t.type === 'error' ? 'bg-red-500 text-white' : 'bg-slate-800 text-white'}`}>
                  {t.type === 'error' ? <AlertCircle size={18} /> : <CheckCircle size={18} />}{t.message}
                </div>
              ))}
            </div>
          );
        };

        const FloatingReactions = ({ votes }) => {
          const [particles, setParticles] = useState([]); const prevVotes = useRef(votes);
          useEffect(() => {
            if (!votes) return; const newParticles = [];
            Object.keys(votes).forEach(key => { const diff = (votes[key] || 0) - (prevVotes.current?.[key] || 0); if (diff > 0) { for (let i = 0; i < Math.min(diff, 5); i++) { newParticles.push({ id: Date.now() + Math.random(), type: key, left: 20 + Math.random() * 60, delay: i * 100 }); } } });
            if (newParticles.length > 0) { setParticles(prev => [...prev, ...newParticles]); if (Math.random() > 0.7) playSound('pop'); }
            prevVotes.current = votes;
          }, [votes]);
          useEffect(() => { const timer = setInterval(() => { setParticles(prev => prev.filter(p => Date.now() - p.id < 3000)); }, 1000); return () => clearInterval(timer); }, []);
          return (
            <div className="absolute inset-0 pointer-events-none overflow-hidden z-20">
              {particles.map(p => (<div key={p.id} className="absolute bottom-0 text-4xl animate-float-up opacity-0" style={{ left: `${p.left}%`, animationName: 'floatUp', animationDuration: '2s', animationDelay: `${p.delay}ms`, animationFillMode: 'forwards' }}>{p.type === 'like' ? 'ğŸ‘' : p.type === 'heart' ? 'â¤ï¸' : 'ğŸ˜„'}</div>))}
              <style>{`@keyframes floatUp { 0% { transform: translateY(0) scale(0.5); opacity: 0; } 10% { opacity: 1; transform: translateY(-20px) scale(1.2); } 100% { transform: translateY(-400px) scale(1); opacity: 0; } }`}</style>
            </div>
          );
        };

        // --- Visualizations ---
        const BarChartVis = ({ data, total, correctOption, isAnswerRevealed }) => {
          const maxVal = Math.max(...Object.values(data || {}), 1); 
          return (
            <div className="w-full h-full flex items-end justify-center gap-4 px-4 pb-8 pt-4">
              {Object.entries(data || {}).map(([label, count], idx) => {
                const heightPercent = total > 0 ? (count / maxVal) * 80 : 0; const isCorrect = label === correctOption; const opacityClass = isAnswerRevealed ? (isCorrect ? 'opacity-100' : 'opacity-30 grayscale') : 'opacity-90'; const colorClass = isAnswerRevealed && isCorrect ? 'bg-green-500' : COLORS[idx % COLORS.length];
                return (
                  <div key={label} className={`flex flex-col items-center justify-end w-20 md:w-24 group transition-all duration-700 flex-shrink-0 ${opacityClass}`}>
                    {isAnswerRevealed && isCorrect && <CheckCircle className="text-green-500 mb-2 animate-bounce" />}
                    <div className="mb-2 font-bold text-xl md:text-2xl text-slate-700">{count}</div>
                    <div className={`w-12 md:w-16 rounded-t-lg transition-all duration-700 ease-out ${colorClass} shadow-lg`} style={{ height: `${Math.max(heightPercent, 1)}%` }} />
                    <div className="mt-3 text-xs md:text-sm font-medium text-slate-600 text-center break-words w-full line-clamp-2">{label}</div>
                  </div>
                );
              })}
            </div>
          );
        };

        const DonutChartVis = ({ data, total, correctOption, isAnswerRevealed }) => {
          let accumulatedAngle = 0;
          const slices = Object.entries(data || {}).map(([label, count], idx) => {
            if (total === 0) return null;
            const percentage = count / total; const angle = percentage * 360; const startAngle = accumulatedAngle; accumulatedAngle += angle;
            const radius = 100; const x1 = 150 + radius * Math.cos(Math.PI * (startAngle - 90) / 180); const y1 = 150 + radius * Math.sin(Math.PI * (startAngle - 90) / 180);
            const x2 = 150 + radius * Math.cos(Math.PI * (startAngle + angle - 90) / 180); const y2 = 150 + radius * Math.sin(Math.PI * (startAngle + angle - 90) / 180);
            const largeArcFlag = angle > 180 ? 1 : 0; const pathData = `M 150 150 L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
            const isCorrect = label === correctOption; let fillColor = ['#3b82f6', '#ef4444', '#eab308', '#22c55e', '#a855f7', '#ec4899'][idx % 6]; let opacity = 1;
            if (isAnswerRevealed) { if (isCorrect) fillColor = '#22c55e'; else { fillColor = '#cbd5e1'; opacity = 0.5; } }
            return <path key={label} d={pathData} fill={fillColor} stroke="white" strokeWidth="2" style={{opacity}} className="transition-all duration-500" />;
          });
          return (
            <div className="flex flex-col items-center justify-center gap-8 h-full p-4 overflow-y-auto">
              <div className="relative w-48 h-48 md:w-64 md:h-64 flex-shrink-0"><svg viewBox="0 0 300 300" className="w-full h-full drop-shadow-xl">{total > 0 ? slices : <circle cx="150" cy="150" r="100" fill="#e2e8f0" />}<circle cx="150" cy="150" r="60" fill="white" /></svg><div className="absolute inset-0 flex items-center justify-center flex-col pointer-events-none"><span className="text-3xl font-bold text-slate-700">{total}</span><span className="text-[10px] text-slate-400 uppercase tracking-wider">Votes</span></div></div>
              <div className="flex flex-wrap justify-center gap-3">
                {Object.entries(data || {}).map(([label, count], idx) => {
                  const percent = total > 0 ? Math.round((count / total) * 100) : 0; const isCorrect = label === correctOption; const isDimmed = isAnswerRevealed && !isCorrect; const isHighlighted = isAnswerRevealed && isCorrect;
                  return (
                    <div key={label} className={`flex items-center gap-2 px-3 py-1 rounded-full text-xs md:text-sm transition-all ${isHighlighted ? 'bg-green-100 ring-2 ring-green-500' : 'bg-slate-100'} ${isDimmed ? 'opacity-40' : ''}`}><div className={`w-3 h-3 rounded-full ${isHighlighted ? 'bg-green-500' : COLORS[idx % COLORS.length]}`}></div><span className="font-medium text-slate-700">{label}</span><span className="font-bold text-slate-900">{percent}%</span>{isHighlighted && <Check size={14} className="text-green-600" />}</div>
                  );
                })}
              </div>
            </div>
          );
        };

        const RankingVis = ({ data }) => {
          const sortedData = Object.entries(data || {}).sort(([, a], [, b]) => b - a); const maxVal = Math.max(...Object.values(data || {}), 1);
          return (
            <div className="w-full h-full flex flex-col justify-center px-4 md:px-8 py-4 overflow-y-auto">
              {sortedData.map(([label, score], idx) => {
                const widthPercent = (score / maxVal) * 100;
                return (
                  <div key={label} className="flex items-center gap-3 mb-3 animate-in slide-in-from-left duration-500" style={{ animationDelay: `${idx * 100}ms` }}><div className={`w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-full font-bold text-sm ${idx === 0 ? 'bg-yellow-400 text-white' : idx === 1 ? 'bg-slate-300 text-slate-600' : idx === 2 ? 'bg-amber-600 text-white' : 'bg-slate-100 text-slate-400'}`}>{idx === 0 ? <Trophy size={14} /> : idx + 1}</div><div className="flex-1 min-w-0"><div className="flex justify-between items-end mb-1"><span className="font-bold text-slate-700 text-sm md:text-base truncate pr-2">{label}</span><span className="text-xs font-semibold text-slate-400 flex-shrink-0">{score} pts</span></div><div className="w-full bg-slate-100 rounded-full h-3 overflow-hidden"><div className={`h-full rounded-full transition-all duration-1000 ease-out ${COLORS[idx % COLORS.length]}`} style={{ width: `${Math.max(widthPercent, 5)}%` }} /></div></div></div>
                );
              })}
            </div>
          );
        };

        const WordCloudVis = ({ votes, isHost, onDelete }) => {
          const counts = useMemo(() => { const c = {}; (votes || []).forEach((v) => { c[v] = (c[v] || 0) + 1; }); return c; }, [votes]);
          const maxCount = Math.max(...Object.values(counts), 1); const sortedWords = Object.entries(counts).sort((a, b) => b[1] - a[1]);
          return (
            <div className="flex flex-wrap items-center justify-center content-center h-full p-8 gap-x-6 gap-y-2 overflow-y-auto">
              {sortedWords.map(([word, count], idx) => {
                const size = 1 + (count / maxCount) * 3; 
                return (
                  <span key={`${word}-${idx}`} className={`font-bold transition-all duration-700 ease-spring ${TEXT_COLORS[idx % TEXT_COLORS.length]} hover:scale-110 cursor-default relative group`} style={{ fontSize: `${size}rem`, opacity: 0.7 + (count / maxCount) * 0.3 }}>{word}{isHost && (<button onClick={(e) => { e.stopPropagation(); if(confirm(`ã€Œ${word}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) onDelete(word); }} className="ml-2 bg-slate-200 text-slate-500 hover:bg-red-500 hover:text-white rounded-full w-5 h-5 text-[10px] inline-flex items-center justify-center align-middle shadow-sm opacity-0 group-hover:opacity-100 transition-all absolute -top-2 -right-3"><X size={12} /></button>)}</span>
                );
              })}
              {sortedWords.length === 0 && <div className="text-slate-400">å›ç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>}
            </div>
          );
        };

        const OpenEndedVis = ({ votes, isHost, onDelete }) => {
          const [focusedVote, setFocusedVote] = useState(null);
          const displayVotes = (votes || []).slice().reverse().map((v) => { if (typeof v === 'string') return { text: v, user: 'Anonymous' }; return v; });
          return (
            <div className="w-full h-full overflow-y-auto p-4 md:p-8">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {displayVotes.map((vote, idx) => (
                  <div key={idx} onClick={() => setFocusedVote(vote)} className="bg-white p-5 rounded-xl shadow-sm border border-slate-100 animate-in zoom-in duration-300 flex flex-col relative overflow-hidden group hover:shadow-md transition-shadow cursor-pointer hover:bg-slate-50">
                    <div className={`absolute top-0 left-0 w-1 h-full ${COLORS[idx % COLORS.length]}`}></div>
                    <div className="flex items-center gap-2 mb-2"><div className="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1"><User size={10} />{vote.user || 'Anonymous'}</div></div>
                    <p className="text-slate-700 font-medium text-lg leading-relaxed break-words whitespace-pre-wrap line-clamp-4">{vote.text}</p>
                    {isHost && <button onClick={(e) => { e.stopPropagation(); if(confirm('ã“ã®å›ç­”ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) onDelete(vote); }} className="absolute top-2 right-2 p-2 bg-white/80 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-all z-10"><Trash2 size={16} /></button>}
                    <div className="absolute bottom-2 right-2 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity"><Maximize2 size={16} /></div>
                  </div>
                ))}
              </div>
              {displayVotes.length === 0 && <div className="flex flex-col items-center justify-center h-full text-slate-400"><MessageSquare size={48} className="mb-4 opacity-30" /><p>å›ç­”ã‚’å¾…ã£ã¦ã„ã¾ã™...</p></div>}
              {focusedVote && (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-8 animate-in fade-in duration-200" onClick={() => setFocusedVote(null)}><div className="bg-white p-12 rounded-3xl shadow-2xl max-w-4xl w-full max-h-[80vh] overflow-y-auto relative text-center" onClick={(e) => e.stopPropagation()}><button onClick={() => setFocusedVote(null)} className="absolute top-4 right-4 p-2 hover:bg-slate-100 rounded-full text-slate-400"><X size={32} /></button><div className="inline-block bg-slate-100 text-slate-600 px-4 py-2 rounded-full font-bold mb-6 text-sm">{focusedVote.user} ã•ã‚“ã®å›ç­”</div><p className="text-3xl md:text-5xl font-bold text-slate-800 leading-relaxed whitespace-pre-wrap">{focusedVote.text}</p></div></div>
              )}
            </div>
          );
        };

        const QaVis = ({ votes, isHost, onMarkAnswered, onDelete, theme }) => {
          const [focusedQ, setFocusedQ] = useState(null);
          const questions = useMemo(() => {
            if (!votes) return [];
            return Object.entries(votes).map(([id, q]) => ({ id, ...q })).sort((a, b) => {
                if (a.answered !== b.answered) return a.answered ? 1 : -1;
                if ((b.likes || 0) !== (a.likes || 0)) return (b.likes || 0) - (a.likes || 0);
                return b.createdAt - a.createdAt;
              });
          }, [votes]);

          return (
            <div className="w-full h-full overflow-y-auto p-4 md:p-8">
              <div className="flex flex-col gap-4 max-w-3xl mx-auto">
                {questions.map((q) => (
                  <div key={q.id} onClick={() => setFocusedQ(q)} className={`p-6 rounded-2xl shadow-sm border transition-all animate-in slide-in-from-bottom-2 cursor-pointer hover:shadow-md ${q.answered ? 'bg-slate-50 border-slate-200 opacity-60' : 'bg-white shadow-md'} ${!q.answered ? THEMES[theme].border : ''}`}>
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <div className="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded-full font-bold flex items-center gap-1"><User size={10} /> {q.user || 'Anonymous'}</div>
                          {q.answered && <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-bold">å›ç­”æ¸ˆã¿</span>}
                        </div>
                        <p className={`text-xl font-bold ${q.answered ? 'text-slate-500' : 'text-slate-800'} leading-relaxed line-clamp-3`}>{q.text}</p>
                      </div>
                      <div className="flex flex-col items-center gap-1 min-w-[50px]">
                        <div className={`flex flex-col items-center ${THEMES[theme].light} ${THEMES[theme].text} rounded-xl p-2 min-w-[60px]`}>
                          <ThumbsUp size={20} className={q.answered ? 'opacity-50' : THEMES[theme].fill} />
                          <span className="font-bold text-lg">{q.likes || 0}</span>
                        </div>
                      </div>
                    </div>
                    {isHost && (
                      <div className="flex justify-end gap-2 mt-4 pt-4 border-t border-slate-100" onClick={(e) => e.stopPropagation()}>
                        <button onClick={() => onMarkAnswered(q.id, !q.answered)} className={`flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold transition-colors ${q.answered ? 'bg-slate-200 text-slate-600' : 'bg-green-50 text-green-600 hover:bg-green-100'}`}><Check size={14} /> {q.answered ? 'æœªå›ç­”ã«æˆ»ã™' : 'å›ç­”æ¸ˆã¿ã«ã™ã‚‹'}</button>
                        <button onClick={() => { if(confirm('ã“ã®è³ªå•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) onDelete(q.id); }} className="flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-bold bg-red-50 text-red-500 hover:bg-red-100 transition-colors"><Trash2 size={14} /> å‰Šé™¤</button>
                      </div>
                    )}
                  </div>
                ))}
                {questions.length === 0 && <div className="flex flex-col items-center justify-center py-20 text-slate-400"><HelpCircle size={64} className="mb-4 opacity-30" /><p>è³ªå•ã‚’å¾…ã£ã¦ã„ã¾ã™...</p></div>}
              </div>

              {focusedQ && (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-8 animate-in fade-in duration-200" onClick={() => setFocusedQ(null)}>
                  <div className="bg-white p-12 rounded-3xl shadow-2xl max-w-5xl w-full max-h-[85vh] overflow-y-auto relative text-center flex flex-col items-center" onClick={(e) => e.stopPropagation()}>
                    <button onClick={() => setFocusedQ(null)} className="absolute top-6 right-6 p-2 hover:bg-slate-100 rounded-full text-slate-400"><X size={32} /></button>
                    <div className={`flex items-center gap-2 mb-8 ${THEMES[theme].light} px-4 py-2 rounded-full`}><User size={16} className={THEMES[theme].text}/><span className={`font-bold ${THEMES[theme].text} text-lg`}>{focusedQ.user}</span></div>
                    <p className="text-4xl md:text-6xl font-bold text-slate-800 leading-tight whitespace-pre-wrap mb-10">{focusedQ.text}</p>
                    <div className={`flex items-center gap-2 ${THEMES[theme].text} mb-8`}><ThumbsUp size={32} className={THEMES[theme].fill} /><span className="text-3xl font-bold">{focusedQ.likes || 0}</span></div>
                    {isHost && (
                      <div className="flex gap-4 border-t border-slate-100 pt-8 w-full justify-center">
                         <button onClick={() => { onMarkAnswered(focusedQ.id, !focusedQ.answered); setFocusedQ(null); }} className={`px-8 py-3 rounded-xl font-bold text-lg flex items-center gap-2 transition-all shadow-lg ${focusedQ.answered ? 'bg-slate-200 text-slate-600' : 'bg-green-600 text-white hover:bg-green-700'}`}><Check size={24} /> {focusedQ.answered ? 'æœªå›ç­”ã«æˆ»ã™' : 'å›ç­”æ¸ˆã¿ã«ã™ã‚‹'}</button>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          );
        };

        const ContentVis = ({ question }) => {
            return (
                <div className="w-full h-full flex flex-col items-center justify-center p-8 text-center animate-in fade-in">
                   {question.image ? <div className="w-full max-w-4xl max-h-[60vh] overflow-hidden rounded-2xl shadow-sm mb-8"><img src={question.image} className="w-full h-full object-contain bg-slate-50" alt="Slide visual" /></div> : <div className="w-24 h-1 bg-slate-300 rounded-full mb-8"></div>}
                   <h2 className="text-4xl md:text-5xl font-bold text-slate-800 mb-6 max-w-4xl leading-tight">{question.question}</h2>
                   {question.options && question.options[0] && <p className="text-xl text-slate-600 max-w-3xl leading-relaxed whitespace-pre-wrap">{question.options[0]}</p>}
                </div>
            )
        }

        const ReactionVis = ({ votes }) => (
          <div className="w-full h-full flex flex-col items-center justify-center gap-12 relative">
            <FloatingReactions votes={votes} />
            <div className="flex items-end justify-center gap-8 relative z-10">
              {[{icon: ThumbsUp, key: 'like', color: 'blue'}, {icon: Heart, key: 'heart', color: 'red'}, {icon: Smile, key: 'smile', color: 'yellow'}].map((item, i) => (
                <div key={item.key} className="flex flex-col items-center gap-4 animate-bounce" style={{ animationDuration: `${2 - i * 0.2}s` }}><item.icon size={64} className={`text-${item.color}-500 fill-${item.color}-100`} /><span className={`text-3xl font-bold text-${item.color}-600`}>{(votes || {})[item.key] || 0}</span></div>
              ))}
            </div>
            <p className="text-slate-500 relative z-10">ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦åå¿œã‚’é€ã£ã¦ãã ã•ã„</p>
          </div>
        );

        // --- Modals and Screens ---
        const FirebaseSettingsModal = ({ isOpen, onClose, onSave, initialConfig }) => {
            const [configStr, setConfigStr] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                if (isOpen && initialConfig) {
                    // JSON stringify the object but format it to look like the js object
                    setConfigStr(JSON.stringify(initialConfig, null, 2));
                }
            }, [isOpen, initialConfig]);

            if (!isOpen) return null;

            const handleSave = () => {
                try {
                    // Try to parse as JSON first
                    let parsed = null;
                    let input = configStr.trim();
                    
                    // Basic cleanup if they pasted the JS code snippet
                    if (input.startsWith('const firebaseConfig =')) {
                        input = input.replace('const firebaseConfig =', '').trim();
                        if (input.endsWith(';')) input = input.slice(0, -1);
                    }
                    
                    // Using Function to evaluate object string safely
                    parsed = new Function("return " + input)();

                    if (!parsed.apiKey || !parsed.projectId) {
                        throw new Error("Invalid config format");
                    }
                    onSave(parsed);
                } catch (e) {
                    setError("è¨­å®šã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸå†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-8">
                        <div className="flex items-center gap-3 mb-6">
                            <Settings className="text-indigo-600" />
                            <h2 className="text-xl font-bold text-slate-800">Firebase è¨­å®š</h2>
                        </div>
                        <p className="text-sm text-slate-600 mb-4">
                            ã‚¢ãƒ—ãƒªã‚’å‹•ã‹ã™ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ï¼ˆfirebaseConfigï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
                            ã“ã®è¨­å®šã¯ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚
                        </p>
                        
                        <div className="mb-4">
                            <textarea 
                                value={configStr} 
                                onChange={(e) => {setConfigStr(e.target.value); setError('');}}
                                className="w-full h-48 p-4 rounded-xl border border-slate-300 font-mono text-sm bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none"
                                placeholder={`{\n  apiKey: "...",\n  authDomain: "...",\n  projectId: "...",\n  ...\n}`}
                            />
                            {error && <p className="text-red-500 text-sm mt-2">{error}</p>}
                        </div>

                        <div className="flex gap-3 justify-end mt-6">
                            <button onClick={onClose} className="px-6 py-2 rounded-xl border border-slate-300 text-slate-600 font-medium hover:bg-slate-50">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button onClick={handleSave} className="px-6 py-2 rounded-xl bg-indigo-600 text-white font-bold hover:bg-indigo-700">ä¿å­˜ã—ã¦é©ç”¨</button>
                        </div>
                    </div>
                </div>
            )
        };

        const CreateQuestionModal = ({ isOpen, onClose, onSave, initialData = null, theme }) => {
          const [type, setType] = useState('choice'); const [question, setQuestion] = useState(''); const [optionsStr, setOptionsStr] = useState(''); const [image, setImage] = useState(null); const [correctOption, setCorrectOption] = useState(null); const [notes, setNotes] = useState(''); const fileInputRef = useRef(null);

          useEffect(() => {
            if (initialData) { setType(initialData.type); setQuestion(initialData.question); setOptionsStr(initialData.options ? initialData.options.join(', ') : ''); setImage(initialData.image); setCorrectOption(initialData.correctOption || null); setNotes(initialData.notes || ''); } 
            else { setType('choice'); setQuestion(''); setOptionsStr(''); setImage(null); setCorrectOption(null); setNotes(''); }
          }, [initialData, isOpen]);

          if (!isOpen) return null;

          const handleImageUpload = async (e) => { const file = e.target.files[0]; if (file) { try { const resized = await resizeImage(file, 800, 0.7); setImage(resized); } catch (err) { alert('ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ'); } } };
          const handleSave = () => {
            if (!question.trim()) return;
            let newQuestion = { id: initialData ? initialData.id : Date.now().toString(), question, type, image, isLocked: initialData ? initialData.isLocked : false, timerEndsAt: initialData ? initialData.timerEndsAt : null, votes: initialData ? initialData.votes : (type === 'wordcloud' || type === 'open' ? [] : (type === 'qa' ? {} : (type === 'reaction' ? { like: 0, heart: 0, smile: 0 } : {}))), order: initialData ? initialData.order : 0, correctOption: type === 'choice' ? correctOption : null, isAnswerRevealed: initialData ? initialData.isAnswerRevealed : false, notes: notes };
            if (type === 'choice' || type === 'ranking') { const opts = optionsStr.split(',').map(s => s.trim()).filter(s => s); newQuestion.options = opts; if (!initialData) { const initialVotes = {}; opts.forEach(o => initialVotes[o] = 0); newQuestion.votes = initialVotes; } newQuestion.allowedVisuals = type === 'choice' ? ['bar', 'donut'] : ['ranking']; } 
            else if (type === 'wordcloud') { newQuestion.allowedVisuals = ['cloud', 'list']; } else if (type === 'open') { newQuestion.allowedVisuals = ['grid']; } else if (type === 'reaction') { newQuestion.allowedVisuals = ['floating']; } else if (type === 'qa') { newQuestion.allowedVisuals = ['list']; } else if (type === 'content') { newQuestion.options = [optionsStr]; newQuestion.allowedVisuals = ['content']; }
            onSave(newQuestion); onClose();
          };
          const currentOptions = optionsStr.split(',').map(s => s.trim()).filter(s => s);

          return (
            <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-lg font-bold text-slate-800 mb-6 flex justify-between">{initialData ? 'ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç·¨é›†' : 'æ–°ã—ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½œæˆ'}<button onClick={onClose}><X size={20} className="text-slate-400 hover:text-slate-600" /></button></h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold text-slate-600 mb-2">ã‚¿ã‚¤ãƒ—</label>
                    <div className="grid grid-cols-4 gap-2">
                      {[{ id: 'choice', label: 'é¸æŠ/ã‚¯ã‚¤ã‚º', icon: <BarChart3 size={16} /> }, { id: 'ranking', label: 'ãƒ©ãƒ³ã‚¯', icon: <ListOrdered size={16} /> }, { id: 'wordcloud', label: 'ãƒ¯ãƒ¼ãƒ‰', icon: <Type size={16} /> }, { id: 'open', label: 'è‡ªç”±', icon: <MessageSquare size={16} /> }, { id: 'qa', label: 'Q&A', icon: <HelpCircle size={16} /> }, { id: 'content', label: 'èª¬æ˜', icon: <FileText size={16} /> }, { id: 'reaction', label: 'åå¿œ', icon: <ThumbsUp size={16} /> }].map((t) => (
                        <button key={t.id} onClick={() => setType(t.id)} className={`flex flex-col items-center justify-center p-2 rounded-xl border text-xs gap-1 transition-all ${type === t.id ? `${THEMES[theme].bg} text-white` : 'border-slate-200 text-slate-500'}`}>{t.icon}<span>{t.label}</span></button>
                      ))}
                    </div>
                  </div>
                  <div><label className="block text-sm font-semibold text-slate-600 mb-2">ã‚¿ã‚¤ãƒˆãƒ« / è³ªå•</label><input type="text" value={question} onChange={(e) => setQuestion(e.target.value)} className={`w-full p-3 rounded-lg border border-slate-300 ${THEMES[theme].ring}`} placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" /></div>
                  <div>
                    <label className="block text-sm font-semibold text-slate-600 mb-2">ç”»åƒ (ä»»æ„)</label>
                    {!image ? (<div onClick={() => fileInputRef.current?.click()} className={`w-full h-24 border-2 border-dashed border-slate-300 rounded-lg flex flex-col items-center justify-center text-slate-400 cursor-pointer hover:bg-slate-50`}><Upload size={20} /><span className="text-xs mt-1">ç”»åƒã‚’é¸æŠ</span><input type="file" accept="image/*" className="hidden" ref={fileInputRef} onChange={handleImageUpload} /></div>) : (<div className="relative w-full h-32 bg-slate-100 rounded-lg overflow-hidden"><img src={image} className="w-full h-full object-contain" /><button onClick={() => {setImage(null); if(fileInputRef.current) fileInputRef.current.value=""}} className="absolute top-1 right-1 p-1 bg-black/50 text-white rounded-full"><X size={14}/></button></div>)}
                  </div>
                  {(type === 'choice' || type === 'ranking') && (
                    <div>
                      <label className="block text-sm font-semibold text-slate-600 mb-2">é¸æŠè‚¢ (ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label><textarea value={optionsStr} onChange={(e) => setOptionsStr(e.target.value)} className={`w-full p-3 rounded-lg border border-slate-300 h-20 resize-none ${THEMES[theme].ring}`} placeholder="A, B, C" />
                      {type === 'choice' && currentOptions.length > 0 && (
                        <div className={`mt-4 p-3 rounded-lg ${THEMES[theme].light}`}>
                          <label className={`block text-xs font-bold ${THEMES[theme].text} mb-2 flex items-center gap-1`}><Award size={12}/> ã‚¯ã‚¤ã‚º: æ­£è§£ã‚’é¸æŠ (ä»»æ„)</label>
                          <div className="space-y-2">
                            <label className="flex items-center gap-2 text-sm cursor-pointer"><input type="radio" name="correctOption" checked={correctOption === null} onChange={() => setCorrectOption(null)} className="accent-indigo-600" /><span className="text-slate-600">æ­£è§£ãªã— (ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ)</span></label>
                            {currentOptions.map((opt, idx) => (
                              <label key={idx} className="flex items-center gap-2 text-sm cursor-pointer"><input type="radio" name="correctOption" value={opt} checked={correctOption === opt} onChange={() => setCorrectOption(opt)} className="accent-green-600" /><span className={correctOption === opt ? 'font-bold text-green-700' : 'text-slate-700'}>{opt}</span></label>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                  {type === 'content' && (<div><label className="block text-sm font-semibold text-slate-600 mb-2">æœ¬æ–‡ / èª¬æ˜</label><textarea value={optionsStr} onChange={(e) => setOptionsStr(e.target.value)} className={`w-full p-3 rounded-lg border border-slate-300 h-32 resize-none ${THEMES[theme].ring}`} placeholder="ã‚¹ãƒ©ã‚¤ãƒ‰ã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ..." /></div>)}
                  <div><label className="block text-sm font-semibold text-slate-600 mb-2">ç™ºè¡¨è€…ç”¨ãƒ¡ãƒ¢</label><textarea value={notes} onChange={(e) => setNotes(e.target.value)} className={`w-full p-3 rounded-lg border border-slate-300 h-20 resize-none ${THEMES[theme].ring}`} placeholder="ã‚«ãƒ³ãƒšã‚„æ™‚é–“é…åˆ†ãªã©..." /></div>
                </div>
                <div className="flex gap-3 mt-6"><button onClick={onClose} className="flex-1 py-2 rounded-xl border border-slate-300 text-slate-600">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button onClick={handleSave} disabled={!question.trim()} className={`flex-1 py-2 rounded-xl text-white font-bold disabled:opacity-50 ${THEMES[theme].bg} ${THEMES[theme].bgHover}`}>{initialData ? 'ä¿å­˜' : 'ä½œæˆ'}</button></div>
              </div>
            </div>
          );
        };

        const LandingPage = ({ onCreate, onJoin, customLogo, setCustomLogo, theme, setTheme, onOpenSettings }) => {
          const [joinCode, setJoinCode] = useState('');
          return (
            <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center relative">
              <button 
                  onClick={onOpenSettings}
                  className="absolute top-4 right-4 p-3 text-slate-400 hover:text-indigo-600 hover:bg-slate-100 rounded-full transition-colors flex items-center gap-2"
                  title="Firebaseè¨­å®š"
              >
                  <Settings size={20} /> <span className="text-sm font-bold hidden md:inline">è¨­å®š</span>
              </button>

              <div className="max-w-md w-full bg-white p-8 rounded-3xl shadow-xl border border-slate-100 mt-8">
                <div className="flex justify-center mb-6"><div className={`p-3 rounded-2xl ${THEMES[theme || 'indigo'].light} ${THEMES[theme || 'indigo'].text}`}><AppLogo customSrc={customLogo} size={80} onUpload={setCustomLogo} editable={true} /></div></div>
                <h1 className="text-3xl font-bold text-slate-800 mb-2">Teddy</h1><p className="text-slate-500 mb-8">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æŠ•ç¥¨ & è¦–è¦šåŒ–ãƒ„ãƒ¼ãƒ«</p>
                <button onClick={() => onCreate(theme)} className={`w-full py-4 text-white rounded-xl font-bold text-lg transition-colors shadow-lg mb-6 flex items-center justify-center gap-2 ${THEMES[theme || 'indigo'].bg} ${THEMES[theme || 'indigo'].bgHover}`}><Monitor size={20} /> ãƒ—ãƒ¬ã‚¼ãƒ³ã‚’å§‹ã‚ã‚‹ (ãƒ›ã‚¹ãƒˆ)</button>
                <div className="flex justify-center gap-2 mb-6">{Object.entries(THEMES).map(([key, t]) => (<button key={key} onClick={() => setTheme(key)} className={`w-6 h-6 rounded-full ${t.bg} border-2 ${theme === key ? 'border-slate-800 scale-110' : 'border-white'} transition-all`} title={t.name}/>))}</div>
                <div className="relative mb-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div><div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-slate-400">ã¾ãŸã¯</span></div></div>
                <form onSubmit={(e) => { e.preventDefault(); if(joinCode) onJoin(joinCode); }} className="space-y-3">
                  <input type="number" value={joinCode} onChange={e => setJoinCode(e.target.value)} placeholder="6æ¡ã®ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" className={`w-full p-4 rounded-xl border-2 border-slate-200 text-center text-xl font-bold tracking-widest focus:outline-none ${THEMES[theme || 'indigo'].ring}`} maxLength={6} />
                  <button type="submit" disabled={joinCode.length < 6} className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-700 transition-colors disabled:opacity-50">å‚åŠ ã™ã‚‹</button>
                </form>
                <p className="mt-4 text-xs text-slate-400">â€»ãƒ­ã‚´ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</p>
              </div>
            </div>
          );
        };

        const useCountdown = (targetDate, onTick, onEnd) => {
          const [timeLeft, setTimeLeft] = useState(0);
          useEffect(() => {
            if (!targetDate) { setTimeLeft(0); return; }
            const interval = setInterval(() => {
              const now = Date.now(); const diff = targetDate - now;
              if (diff <= 0) { setTimeLeft(0); clearInterval(interval); if (onEnd) onEnd(); } 
              else { const sec = Math.ceil(diff / 1000); setTimeLeft(sec); if (sec <= 5 && onTick) onTick(); }
            }, 1000);
            return () => clearInterval(interval);
          }, [targetDate]);
          return timeLeft;
        };

        // --- Main Application ---
        function App() {
          const [isFirebaseReady, setIsFirebaseReady] = useState(false);
          const [firebaseInstance, setFirebaseInstance] = useState({ app: null, auth: null, db: null });
          const [isSettingsOpen, setIsSettingsOpen] = useState(false);
          const [savedConfig, setSavedConfig] = useState(null);

          const [user, setUser] = useState(null);
          const [mode, setMode] = useState('landing');
          const [roomId, setRoomId] = useState('');
          const [sessionData, setSessionData] = useState(null);
          const [isModalOpen, setIsModalOpen] = useState(false);
          const [editingQuestion, setEditingQuestion] = useState(null);
          const [visualType, setVisualType] = useState('default'); 
          const [rankingSelection, setRankingSelection] = useState([]);
          const [showQr, setShowQr] = useState(false);
          const [customLogo, setCustomLogo] = useState(null);
          const [voterName, setVoterName] = useState(() => localStorage.getItem('teddy_voterName') || '');
          const [toasts, setToasts] = useState([]); 
          const [isFullscreen, setIsFullscreen] = useState(false);
          const [showShortcuts, setShowShortcuts] = useState(false);
          const [soundEnabled, setSoundEnabled] = useState(true);
          const [votedQuestions, setVotedQuestions] = useState(() => JSON.parse(localStorage.getItem('teddy_voted_questions') || '[]'));
          const [showNotes, setShowNotes] = useState(false);
          const [selectedTheme, setSelectedTheme] = useState('indigo');
          const configInputRef = useRef(null);

          const addToast = (message, type = 'success') => {
            const id = Date.now(); setToasts(prev => [...prev, { id, message, type }]);
            setTimeout(() => { setToasts(prev => prev.filter(t => t.id !== id)); }, 3000);
          };

          // --- Firebase Setup Effect ---
          useEffect(() => {
              // Try to load config from localStorage
              const storedStr = localStorage.getItem('teddy_firebase_config');
              if (storedStr) {
                  try {
                      const conf = JSON.parse(storedStr);
                      setSavedConfig(conf);
                      initFirebase(conf);
                  } catch (e) {
                      setIsSettingsOpen(true);
                  }
              } else {
                  setIsSettingsOpen(true);
              }
          }, []);

          const initFirebase = async (config) => {
              try {
                  // Check if already initialized to prevent errors
                  let currentApp;
                  try {
                      currentApp = getApp("[DEFAULT]");
                  } catch (e) {
                      currentApp = initializeApp(config);
                  }

                  const currentAuth = getAuth(currentApp);
                  const currentDb = getFirestore(currentApp);

                  setFirebaseInstance({ app: currentApp, auth: currentAuth, db: currentDb });
                  
                  // Setup auth listener
                  onAuthStateChanged(currentAuth, (user) => {
                      setUser(user);
                  });

                  // Sign in anonymously
                  await signInAnonymously(currentAuth);
                  setIsFirebaseReady(true);
              } catch (error) {
                  console.error("Firebase init error:", error);
                  addToast('Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
                  setIsSettingsOpen(true);
                  setIsFirebaseReady(false);
              }
          };

          const handleSaveConfig = (newConfig) => {
              localStorage.setItem('teddy_firebase_config', JSON.stringify(newConfig));
              setSavedConfig(newConfig);
              setIsSettingsOpen(false);
              initFirebase(newConfig);
              // Force reload to cleanly re-initialize firebase if changing configs
              if (firebaseInstance.app) {
                 window.location.reload();
              }
          };

          // URL Param handling
          useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            const urlRoomId = params.get('room'); const urlMode = params.get('mode');
            if (urlRoomId) { setRoomId(urlRoomId); setMode(urlMode === 'host' ? 'host' : 'voter'); } 
            else {
              const storedRoomId = localStorage.getItem('teddy_roomId'); const storedMode = localStorage.getItem('teddy_mode');
              if (storedRoomId && storedMode) { setRoomId(storedRoomId); setMode(storedMode); }
            }
          }, []);

          // Data Fetching Effect (Only runs if Firebase is ready)
          useEffect(() => {
            if (!isFirebaseReady || !roomId || !user) return;
            const { db } = firebaseInstance;
            
            const unsub = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), (docSnap) => {
              if (docSnap.exists()) { 
                setSessionData(docSnap.data()); 
              } else {
                // â˜…ä¿®æ­£: ãƒ›ã‚¹ãƒˆã§ã‚‚å‚åŠ è€…ã§ã‚‚ã€ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°è¨˜æ†¶ã‚’æ¶ˆã—ã¦æœ€åˆã®ç”»é¢ã«æˆ»ã‚‹
                localStorage.removeItem('teddy_roomId'); 
                localStorage.removeItem('teddy_mode');
                addToast('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã€‚', 'error'); 
                setRoomId(''); 
                setMode('landing');
              }
            }, (error) => {
                console.error(error);
                if (error.code === 'permission-denied') {
                    addToast('æ¨©é™ã‚¨ãƒ©ãƒ¼: Firestoreã®ãƒ«ãƒ¼ãƒ«è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'error');
                } else {
                    addToast('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
                // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚è¨˜æ†¶ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒ›ãƒ¼ãƒ ã«æˆ»ã™
                localStorage.removeItem('teddy_roomId'); 
                localStorage.removeItem('teddy_mode');
                setRoomId(''); 
                setMode('landing');
            });
            return () => unsub();
          }, [isFirebaseReady, roomId, user, mode, firebaseInstance]);

          const activeQuestion = sessionData ? sessionData.questions[sessionData.activeQuestionId] : null;
          const timerEndsAt = activeQuestion?.timerEndsAt;
          const currentTheme = sessionData?.theme || selectedTheme || 'indigo';
          
          const handleTick = () => { if (mode === 'host' && soundEnabled) playSound('tick'); };
          const handleTimerEnd = () => { if (mode === 'host' && soundEnabled) playSound('end'); };
          const timeLeft = useCountdown(timerEndsAt, handleTick, handleTimerEnd);

          useEffect(() => {
            if (mode !== 'host' || !sessionData) return;
            const handleKeyDown = (e) => {
              if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
              const sortedQuestions = Object.values(sessionData.questions).sort((a,b) => (a.order || 0) - (b.order || 0) || a.id - b.id);
              const currentIndex = sortedQuestions.findIndex((q) => q.id === sessionData.activeQuestionId);
              switch(e.key) {
                case 'ArrowRight': case 'ArrowDown': if (currentIndex < sortedQuestions.length - 1) updateActiveQuestion((sortedQuestions[currentIndex + 1]).id); break;
                case 'ArrowLeft': case 'ArrowUp': if (currentIndex > 0) updateActiveQuestion((sortedQuestions[currentIndex - 1]).id); break;
                case 'h': case 'H': toggleResults(); break;
                case 'l': case 'L': toggleLock(); break;
                case 't': case 'T': if (timeLeft === 0) startTimer(); break;
                case 'f': case 'F': toggleFullscreen(); break;
              }
            };
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
          }, [mode, sessionData, timeLeft]);

          useEffect(() => {
            if (mode === 'host' && timerEndsAt && timeLeft === 0 && activeQuestion && !activeQuestion.isLocked && isFirebaseReady) {
              const qId = sessionData.activeQuestionId;
              updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${qId}.isLocked`]: true, [`questions.${qId}.timerEndsAt`]: null }).catch(e => console.error(e));
            }
          }, [timeLeft, timerEndsAt, mode, activeQuestion, isFirebaseReady]);

          // --- Actions --- (All guarded by isFirebaseReady)
          const createSession = async (themeToUse) => {
            if (!isFirebaseReady || !user) { addToast("è¨­å®šãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“", 'error'); return; }
            const newRoomId = generateRoomId();
            const sessionDoc = { roomId: newRoomId, hostId: user.uid, createdAt: Date.now(), activeQuestionId: '1', questions: INITIAL_QUESTIONS_TEMPLATE, logoImage: customLogo, showResults: true, theme: themeToUse };
            try {
              await setDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, newRoomId), sessionDoc);
              setRoomId(newRoomId); setMode('host'); localStorage.setItem('teddy_roomId', newRoomId); localStorage.setItem('teddy_mode', 'host');
              try { const url = new URL(window.location.href); url.searchParams.set('room', newRoomId); url.searchParams.set('mode', 'host'); window.history.pushState({}, '', url); } catch (e) { console.warn(e); }
            } catch (e) { console.error(e); addToast("ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message, 'error'); }
          };

          const joinSession = (code) => {
            setRoomId(code); setMode('voter'); localStorage.setItem('teddy_roomId', code); localStorage.setItem('teddy_mode', 'voter');
            try { const url = new URL(window.location.href); url.searchParams.set('room', code); window.history.pushState({}, '', url); } catch (e) {}
          };

          const exitSession = () => {
            if (confirm('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰é€€å‡ºã—ã¾ã™ã‹ï¼Ÿ')) {
              setRoomId(''); setMode('landing'); setSessionData(null); setRankingSelection([]); localStorage.removeItem('teddy_roomId'); localStorage.removeItem('teddy_mode');
              try { window.history.pushState({}, '', window.location.pathname); } catch (e) {}
            }
          };

          const handleSetVoterName = (name) => { setVoterName(name); localStorage.setItem('teddy_voterName', name); };
          
          const updateActiveQuestion = async (qId) => { 
            if (!isFirebaseReady || !user || !roomId) return; 
            try { await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { activeQuestionId: qId }); setVisualType('default'); } 
            catch(e) { console.error(e); addToast('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
          };
          
          const updateTheme = async (newTheme) => { 
            if (!isFirebaseReady || !user || !roomId) return; 
            try { await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { theme: newTheme }); }
            catch(e) { console.error(e); addToast('æ“ä½œã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
          };

          const saveQuestion = async (newQ) => {
            if (!isFirebaseReady || !user || !roomId || !sessionData) return;
            const questionsArr = Object.values(sessionData.questions);
            if (!editingQuestion) { const maxOrder = questionsArr.reduce((max, q) => Math.max(max, q.order || 0), 0); newQ.order = maxOrder + 1; }
            try {
                await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${newQ.id}`]: newQ });
                if (!editingQuestion) updateActiveQuestion(newQ.id);
                addToast(editingQuestion ? 'ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½œæˆã—ã¾ã—ãŸ');
            } catch(e) { console.error(e); addToast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
          };

          const duplicateQuestion = async (qId) => {
            if (!isFirebaseReady || !user || !roomId || !sessionData) return;
            const originalQ = sessionData.questions[qId]; const newId = Date.now().toString();
            const maxOrder = Object.values(sessionData.questions).reduce((max, q) => Math.max(max, q.order || 0), 0);
            let resetVotes = (originalQ.type === 'wordcloud' || originalQ.type === 'open') ? [] : (originalQ.type === 'qa' ? {} : (originalQ.type === 'reaction' ? { like: 0, heart: 0, smile: 0 } : {}));
            if (originalQ.type === 'choice' || originalQ.type === 'ranking') { resetVotes = {}; originalQ.options.forEach((opt) => resetVotes[opt] = 0); }
            const newQ = { ...originalQ, id: newId, question: `${originalQ.question} (ã‚³ãƒ”ãƒ¼)`, votes: resetVotes, order: maxOrder + 1 };
            try {
                await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${newId}`]: newQ });
                updateActiveQuestion(newId); addToast('ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’è¤‡è£½ã—ã¾ã—ãŸ');
            } catch(e) { console.error(e); addToast('è¤‡è£½ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
          };

          const moveQuestion = async (qId, direction) => {
            if (!isFirebaseReady || !user || !roomId || !sessionData) return;
            const questionsArr = Object.values(sessionData.questions).sort((a,b) => (a.order || 0) - (b.order || 0) || a.id - b.id);
            const idx = questionsArr.findIndex((q) => q.id === qId); if (idx === -1) return;
            try {
                if (direction === 'up' && idx > 0) {
                    await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${questionsArr[idx].id}.order`]: questionsArr[idx - 1].order || 0, [`questions.${questionsArr[idx - 1].id}.order`]: questionsArr[idx].order || 0 });
                } else if (direction === 'down' && idx < questionsArr.length - 1) {
                    await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${questionsArr[idx].id}.order`]: questionsArr[idx + 1].order || 0, [`questions.${questionsArr[idx + 1].id}.order`]: questionsArr[idx].order || 0 });
                }
            } catch(e) { console.error(e); addToast('ç§»å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
          };

          const deleteQuestion = async (qId) => {
            if (!isFirebaseReady || !user || !roomId || !sessionData) return;
            if (Object.keys(sessionData.questions).length <= 1) { addToast("æœ€å¾Œã®ã‚¹ãƒ©ã‚¤ãƒ‰ã¯å‰Šé™¤ã§ãã¾ã›ã‚“", 'error'); return; }
            if (!confirm('ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            try {
                await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${qId}`]: deleteField() });
                if (sessionData.activeQuestionId === qId) {
                    const remaining = Object.values(sessionData.questions).filter((q) => q.id !== qId).sort((a,b) => (a.order || 0) - (b.order || 0));
                    if (remaining.length > 0) updateActiveQuestion(remaining[0].id);
                }
                addToast('ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch(e) { console.error(e); addToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ", 'error'); }
          };

          const toggleResults = async () => { 
            if (!isFirebaseReady || !user || !roomId || !sessionData) return; 
            try { await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { showResults: !(sessionData.showResults ?? true) }); }
            catch(e) { console.error(e); addToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error'); }
          };
          
          const resetVotes = async () => {
            if (!isFirebaseReady || !user || !roomId || !sessionData) return; if (!confirm('ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã®æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
            const qId = sessionData.activeQuestionId; const question = sessionData.questions[qId];
            let resetValue = (question.type === 'wordcloud' || question.type === 'open') ? [] : (question.type === 'qa' ? {} : (question.type === 'reaction' ? { like: 0, heart: 0, smile: 0 } : {}));
            if (question.type === 'choice' || question.type === 'ranking') { question.options.forEach((opt) => resetValue[opt] = 0); }
            try {
                await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${qId}.votes`]: resetValue });
                addToast('æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            } catch(e) { console.error(e); addToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error'); }
          };

          const toggleLock = async () => { 
            if (!isFirebaseReady || !user || !roomId || !sessionData) return; 
            const qId = sessionData.activeQuestionId; 
            try { await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${qId}.isLocked`]: !(sessionData.questions[qId].isLocked || false) }); }
            catch(e) { console.error(e); addToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error'); }
          };

          const toggleAnswer = async () => {
            if (!isFirebaseReady || !user || !roomId || !sessionData) return; const qId = sessionData.activeQuestionId; const isRevealed = sessionData.questions[qId].isAnswerRevealed || false;
            try {
                await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${qId}.isAnswerRevealed`]: !isRevealed });
                if (!isRevealed && soundEnabled) playSound('correct');
            } catch(e) { console.error(e); addToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error'); }
          };

          const startTimer = async () => { 
            if (!isFirebaseReady || !user || !roomId || !sessionData) return; 
            const qId = sessionData.activeQuestionId; 
            try { await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${qId}.timerEndsAt`]: Date.now() + 30000, [`questions.${qId}.isLocked`]: false }); }
            catch(e) { console.error(e); addToast('ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
          };

          const copyLink = () => {
            const url = `${window.location.origin}${window.location.pathname.replace(/\/$/, '')}?room=${roomId}`;
            navigator.clipboard.writeText(url).then(() => { addToast('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }).catch(() => {
              const textArea = document.createElement("textarea"); textArea.value = url; document.body.appendChild(textArea); textArea.select(); document.execCommand("copy"); document.body.removeChild(textArea); addToast('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
          };

          const toggleFullscreen = () => {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().then(() => setIsFullscreen(true)).catch(e => console.log(e)); } 
            else { if (document.exitFullscreen) { document.exitFullscreen().then(() => setIsFullscreen(false)); } }
          };

          const exportConfig = () => {
            if (!sessionData) return;
            const config = { title: "Teddy Session Config", exportedAt: new Date().toISOString(), questions: sessionData.questions };
            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `teddy_config_${roomId}.json`; document.body.appendChild(link); link.click(); document.body.removeChild(link); addToast('æ§‹æˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          };

          const importConfig = (e) => {
            const file = e.target.files[0]; if (!file) return;
            if (!confirm('ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰æ§‹æˆãŒã™ã¹ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) { e.target.value = ''; return; }
            const reader = new FileReader();
            reader.onload = async (event) => {
              try {
                const config = JSON.parse(event.target.result);
                if (config.questions && typeof config.questions === 'object') {
                    const cleanQuestions = {};
                    Object.entries(config.questions).forEach(([key, q]) => {
                        let resetVotes = (q.type === 'wordcloud' || q.type === 'open') ? [] : (q.type === 'qa' ? {} : (q.type === 'reaction' ? { like: 0, heart: 0, smile: 0 } : {}));
                        if (q.type === 'choice' || q.type === 'ranking') { resetVotes = {}; (q.options || []).forEach((opt) => resetVotes[opt] = 0); }
                        cleanQuestions[key] = { ...q, votes: resetVotes, isLocked: false, isAnswerRevealed: false, timerEndsAt: null };
                    });
                    await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { questions: cleanQuestions, activeQuestionId: Object.keys(cleanQuestions)[0] });
                    addToast('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } else { addToast('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™', 'error'); }
              } catch (err) { console.error(err); addToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error'); }
            };
            reader.readAsText(file); e.target.value = '';
          };

          const downloadResults = () => {
            if (!sessionData) return; let csvContent = "\uFEFFSlide ID,Question,Type,User,Answer,Count/Likes\n";
            Object.values(sessionData.questions).sort((a,b) => (a.order || 0) - (b.order || 0)).forEach((q, idx) => {
              const qText = `"${(q.question || "").replace(/"/g, '""')}"`;
              if (q.type === 'choice' || q.type === 'ranking') { Object.entries(q.votes).forEach(([opt, count]) => { csvContent += `${idx+1},${qText},${q.type},-, "${opt.replace(/"/g, '""')}", ${count}\n`; }); } 
              else if (q.type === 'reaction') { csvContent += `${idx+1},${qText},reaction,-,Like,${q.votes.like}\n${idx+1},${qText},reaction,-,Heart,${q.votes.heart}\n${idx+1},${qText},reaction,-,Smile,${q.votes.smile}\n`; } 
              else if (q.type === 'wordcloud') { const counts = {}; (q.votes || []).forEach((v) => { counts[v] = (counts[v] || 0) + 1; }); Object.entries(counts).forEach(([word, count]) => { csvContent += `${idx+1},${qText},wordcloud,-, "${word.replace(/"/g, '""')}", ${count}\n`; }); } 
              else if (q.type === 'open') { (q.votes || []).forEach((v) => { const user = typeof v === 'object' ? v.user : 'Anonymous'; const text = typeof v === 'object' ? v.text : v; csvContent += `${idx+1},${qText},open, "${user.replace(/"/g, '""')}", "${text.replace(/"/g, '""')}",-\n`; }); } 
              else if (q.type === 'qa') { Object.values(q.votes || {}).forEach((v) => { csvContent += `${idx+1},${qText},qa, "${v.user.replace(/"/g, '""')}", "${v.text.replace(/"/g, '""')}", ${v.likes}\n`; }); }
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `teddy_results_${roomId}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); addToast('çµæœã‚’CSVã§ä¿å­˜ã—ã¾ã—ãŸ');
          };

          const downloadQr = () => {
              const canvas = document.createElement('canvas'); const img = new Image(); img.crossOrigin = 'Anonymous'; img.src = `https://api.qrserver.com/v1/create-qr-code/?size=500x500&data=${encodeURIComponent(window.location.origin + window.location.pathname.replace(/\/$/, '') + '?room=' + roomId)}`;
              img.onload = () => { canvas.width = img.width; canvas.height = img.height; const ctx = canvas.getContext('2d'); if(ctx) ctx.drawImage(img, 0, 0); const url = canvas.toDataURL('image/png'); const link = document.createElement('a'); link.href = url; link.download = `teddy_qr_${roomId}.png`; document.body.appendChild(link); link.click(); document.body.removeChild(link); addToast('QRã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ'); }
          };

          const deleteVote = async (value) => {
            if (!isFirebaseReady || !user || !roomId || !sessionData) return; const qId = sessionData.activeQuestionId; const question = sessionData.questions[qId];
            try {
              if (question.type === 'qa') { await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${qId}.votes.${value}`]: deleteField() }); } 
              else if (question.type === 'wordcloud' || question.type === 'open') { await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${qId}.votes`]: arrayRemove(value) }); }
              addToast('å›ç­”ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            } catch (e) { console.error(e); addToast("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ", 'error'); }
          };

          const markQaAnswered = async (msgId, isAnswered) => { 
            if (!isFirebaseReady || !user || !roomId || !sessionData) return; const qId = sessionData.activeQuestionId; 
            try { await updateDoc(doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId), { [`questions.${qId}.votes.${msgId}.answered`]: isAnswered }); }
            catch(e) { console.error(e); addToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error'); }
          };

          const submitVote = async (value) => {
            if (!isFirebaseReady || !user || !roomId || !sessionData) return; const qId = sessionData.activeQuestionId;
            if (['choice', 'ranking'].includes(sessionData.questions[qId].type)) {
               if (votedQuestions.includes(qId)) { addToast("ã™ã§ã«æŠ•ç¥¨æ¸ˆã¿ã§ã™", 'error'); return; }
               const newVoted = [...votedQuestions, qId]; setVotedQuestions(newVoted); localStorage.setItem('teddy_voted_questions', JSON.stringify(newVoted));
            }
            if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(50);
            const question = sessionData.questions[qId]; const docRef = doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId);
            try {
              if (question.type === 'choice' || question.type === 'reaction') { await updateDoc(docRef, { [`questions.${qId}.votes.${value}`]: increment(1) }); } 
              else if (question.type === 'wordcloud') { await updateDoc(docRef, { [`questions.${qId}.votes`]: arrayUnion(value) }); } 
              else if (question.type === 'open') { await updateDoc(docRef, { [`questions.${qId}.votes`]: arrayUnion({ text: value, user: voterName || 'Anonymous' }) }); } 
              else if (question.type === 'ranking') { const updates = {}; value.forEach((opt, idx) => { updates[`questions.${qId}.votes.${opt}`] = increment(Math.max(3 - idx, 1)); }); await updateDoc(docRef, updates); } 
              else if (question.type === 'qa') { const msgId = Date.now().toString(); await updateDoc(docRef, { [`questions.${qId}.votes.${msgId}`]: { text: value, user: voterName || 'Anonymous', likes: 0, answered: false, createdAt: Date.now() } }); }
              if(mode === 'voter') addToast("é€ä¿¡ã—ã¾ã—ãŸï¼");
            } catch (e) { console.error(e); addToast("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ", 'error'); }
          };

          const toggleQaLike = async (msgId) => { 
            if (!isFirebaseReady || !user || !roomId || !sessionData) return; const qId = sessionData.activeQuestionId; const docRef = doc(firebaseInstance.db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, roomId); 
            try { await updateDoc(docRef, { [`questions.${qId}.votes.${msgId}.likes`]: increment(1) }); } catch(e) {}
          };

          const questions = sessionData ? Object.values(sessionData.questions).sort((a,b) => (a.order || 0) - (b.order || 0) || a.id - b.id) : [];
          const currentVisual = (activeQuestion && visualType === 'default') ? activeQuestion.allowedVisuals[0] : visualType;
          const displayLogo = sessionData?.logoImage || customLogo;
          const totalVotes = calculateTotalVotes(activeQuestion);
          const hasVotedCurrent = votedQuestions.includes(activeQuestion?.id);

          if (!isFirebaseReady && !isSettingsOpen) {
              return <div className="flex h-screen items-center justify-center bg-slate-50"><div className="animate-pulse flex flex-col items-center gap-4"><Settings size={48} className="text-slate-300 animate-spin" /><span className="text-slate-400 font-bold tracking-widest">LOADING SETTINGS...</span></div></div>
          }

          if (mode === 'landing') return (
            <React.Fragment>
              <LandingPage onCreate={createSession} onJoin={joinSession} customLogo={customLogo} setCustomLogo={setCustomLogo} theme={selectedTheme} setTheme={setSelectedTheme} onOpenSettings={() => setIsSettingsOpen(true)} />
              <FirebaseSettingsModal isOpen={isSettingsOpen} onClose={() => { if(savedConfig) setIsSettingsOpen(false); else addToast('è¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„', 'error'); }} onSave={handleSaveConfig} initialConfig={savedConfig} />
              <ToastContainer toasts={toasts} />
            </React.Fragment>
          );

          if (!sessionData || !activeQuestion) return <div className="flex h-screen items-center justify-center">Loading Session...</div>;

          if (mode === 'host') {
            return (
              <div className="flex h-screen bg-slate-50 text-slate-800 font-sans overflow-hidden">
                {!isFullscreen && (
                <aside className="w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-lg">
                  <div className="p-4 border-b border-slate-200 flex items-center justify-between">
                    <div className="flex items-center gap-2"><AppLogo customSrc={displayLogo} size={32} className={`${THEMES[currentTheme].text}`} /><h1 className="font-bold text-lg">Teddy</h1></div>
                    <button onClick={exitSession} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-full" title="é€€å‡º"><LogOut size={18} /></button>
                  </div>
                  <div className={`p-4 ${THEMES[currentTheme].light} border-b border-indigo-100`}>
                     <div className={`text-xs font-bold ${THEMES[currentTheme].text} uppercase`}>Room Code</div>
                     <div className="text-2xl font-black text-slate-800 tracking-widest">{roomId}</div>
                     <div className="flex items-center gap-2 mt-1"><span className={`text-xs ${THEMES[currentTheme].text}`}>å‚åŠ è€…ã«ä¼ãˆã¦ãã ã•ã„</span><button onClick={copyLink} className={`${THEMES[currentTheme].textHover} p-1`} title="ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼"><Copy size={14}/></button></div>
                  </div>
                  <div className="flex-1 overflow-y-auto p-4 space-y-6">
                    <div>
                      <div className="flex items-center justify-between mb-3"><h2 className="text-xs font-semibold text-slate-400 uppercase tracking-wider">ã‚¹ãƒ©ã‚¤ãƒ‰</h2><button onClick={() => { setEditingQuestion(null); setIsModalOpen(true); }} className={`text-xs flex items-center gap-1 ${THEMES[currentTheme].text} font-bold ${THEMES[currentTheme].lightHover} px-2 py-1 rounded transition-colors`}><Plus size={12} /> è¿½åŠ </button></div>
                      <div className="space-y-2">
                        {questions.map((q, idx) => (
                          <div key={q.id} className="relative group flex items-center gap-1">
                            <div className="flex flex-col"><button onClick={(e) => { e.stopPropagation(); moveQuestion(q.id, 'up') }} className={`text-slate-300 ${THEMES[currentTheme].textHover} p-0.5`}><ArrowUp size={10} /></button><button onClick={(e) => { e.stopPropagation(); moveQuestion(q.id, 'down') }} className={`text-slate-300 ${THEMES[currentTheme].textHover} p-0.5`}><ArrowDown size={10} /></button></div>
                            <div className="flex-1 relative group">
                                <button onClick={() => updateActiveQuestion(q.id)} className={`w-full text-left p-3 rounded-lg text-sm transition-all border ${sessionData.activeQuestionId === q.id ? `${THEMES[currentTheme].light} ${THEMES[currentTheme].border} ${THEMES[currentTheme].text} shadow-sm` : 'hover:bg-slate-50 border-transparent text-slate-600'}`}>
                                <div className="flex items-center gap-2 mb-1"><span className="font-bold text-xs bg-slate-200 px-1.5 py-0.5 rounded text-slate-600">{idx + 1}</span><span className="font-medium truncate">{q.type === 'open' ? 'è‡ªç”±è¨˜è¿°' : (q.type === 'qa' ? 'Q&A' : (q.type === 'content' ? 'èª¬æ˜' : q.type))}</span></div>
                                <div className="truncate opacity-80 pl-6 pr-6">{q.question}</div>
                                </button>
                                <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1 bg-white/90 rounded shadow-sm p-0.5"><button onClick={(e) => { e.stopPropagation(); setEditingQuestion(q); setIsModalOpen(true); }} className={`p-1.5 text-slate-400 ${THEMES[currentTheme].textHover} rounded`} title="ç·¨é›†"><Edit3 size={12} /></button><button onClick={(e) => { e.stopPropagation(); duplicateQuestion(q.id); }} className={`p-1.5 text-slate-400 ${THEMES[currentTheme].textHover} rounded`} title="è¤‡è£½"><DuplicateIcon size={12} /></button><button onClick={(e) => { e.stopPropagation(); deleteQuestion(q.id); }} className="p-1.5 text-slate-400 hover:text-red-500 rounded" title="å‰Šé™¤"><Trash2 size={12} /></button></div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                    <div>
                      <h2 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">è¦–è¦šåŒ–ã‚¿ã‚¤ãƒ—</h2>
                      <div className="grid grid-cols-2 gap-2">{activeQuestion.allowedVisuals.map((vis) => (<button key={vis} onClick={() => setVisualType(vis)} className={`p-2 rounded border text-center text-sm capitalize ${currentVisual === vis ? `${THEMES[currentTheme].bg} text-white` : 'bg-white text-slate-600'}`}>{vis}</button>))}</div>
                    </div>
                    <div>
                       <h2 className="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">ãƒ†ãƒ¼ãƒ</h2>
                       <div className="flex gap-2">{Object.entries(THEMES).map(([key, t]) => (<button key={key} onClick={() => updateTheme(key)} className={`w-6 h-6 rounded-full ${t.bg} border-2 ${currentTheme === key ? 'border-slate-800 scale-110' : 'border-white'} transition-all`} title={t.name}/>))}</div>
                    </div>
                  </div>
                  <div className="p-4 border-t border-slate-200 space-y-2">
                    <button onClick={downloadResults} className={`w-full flex items-center justify-center gap-2 text-sm text-slate-500 ${THEMES[currentTheme].textHover} ${THEMES[currentTheme].lightHover} py-2 rounded transition-colors`}><FileSpreadsheet size={16} /> çµæœã‚’ä¿å­˜ (.csv)</button>
                    <div className="grid grid-cols-2 gap-2"><button onClick={exportConfig} className={`flex items-center justify-center gap-1 text-xs text-slate-500 ${THEMES[currentTheme].textHover} ${THEMES[currentTheme].lightHover} py-2 rounded transition-colors border border-transparent hover:border-indigo-100`}><FileJson size={14} /> æ§‹æˆã‚’ä¿å­˜</button><button onClick={() => configInputRef.current?.click()} className={`flex items-center justify-center gap-1 text-xs text-slate-500 ${THEMES[currentTheme].textHover} ${THEMES[currentTheme].lightHover} py-2 rounded transition-colors border border-transparent hover:border-indigo-100`}><FolderInput size={14} /> æ§‹æˆã‚’èª­è¾¼</button><input type="file" ref={configInputRef} className="hidden" accept=".json" onChange={importConfig} /></div>
                    <a href={`?room=${roomId}`} target="_blank" rel="noopener noreferrer" className={`w-full flex items-center justify-center gap-2 text-sm ${THEMES[currentTheme].text} ${THEMES[currentTheme].light} hover:bg-opacity-80 py-2 rounded transition-colors font-bold`}><ExternalLink size={16} /> å‚åŠ è€…ç”»é¢ã‚’é–‹ã</a>
                  </div>
                </aside>
                )}
                <main className="flex-1 flex flex-col relative bg-gradient-to-br from-slate-50 to-slate-100">
                  <div className={`${isFullscreen ? 'fixed top-0 left-0 right-0 z-50 p-4' : 'h-16 px-8'} flex items-center justify-between transition-all`}>
                    {!isFullscreen && (
                      <div className="flex items-center gap-4"><span className="text-slate-400 text-sm">Join at <strong className="text-slate-800">teddy.app</strong> with code <strong className="text-slate-800 text-lg">{roomId}</strong></span><button onClick={copyLink} className={`p-2 hover:bg-white rounded-full text-slate-400 ${THEMES[currentTheme].textHover}`} title="ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼"><Copy size={16}/></button></div>
                    )}
                    <div className={`flex items-center gap-2 ${isFullscreen ? 'ml-auto bg-white/80 backdrop-blur p-2 rounded-full shadow-sm' : ''}`}>
                      <button onClick={() => setShowNotes(!showNotes)} className={`p-2 rounded-full transition-colors ${showNotes ? `${THEMES[currentTheme].light} ${THEMES[currentTheme].text}` : 'hover:bg-white text-slate-500'}`} title="ç™ºè¡¨è€…ãƒ¡ãƒ¢"><StickyNote size={20}/></button>
                      <button onClick={() => setSoundEnabled(!soundEnabled)} className="p-2 hover:bg-white rounded-full transition-colors text-slate-500" title={soundEnabled ? "éŸ³å£°ã‚’ãƒŸãƒ¥ãƒ¼ãƒˆ" : "éŸ³å£°ã‚’ã‚ªãƒ³"}>{soundEnabled ? <Volume2 size={20}/> : <VolumeX size={20}/>}</button>
                      <div className="flex items-center gap-1 bg-white px-3 py-1.5 rounded-full shadow-sm text-sm text-slate-600"><Users size={16} /><span>{totalVotes}</span></div>
                      <button onClick={() => setShowQr(!showQr)} className="p-2 hover:bg-white rounded-full transition-colors"><Smartphone size={20} className="text-slate-500" /></button>
                      <button onClick={toggleFullscreen} className="p-2 hover:bg-white rounded-full transition-colors text-slate-500" title="ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ (F)">{isFullscreen ? <Minimize2 size={20} /> : <Maximize2 size={20} />}</button>
                    </div>
                  </div>
                  <div className={`flex-1 flex flex-col items-center justify-center p-8 overflow-hidden relative ${isFullscreen ? 'h-screen' : ''}`}>
                    <h2 className="text-3xl md:text-4xl font-bold text-slate-800 text-center mb-8 max-w-4xl">{activeQuestion.question}</h2>
                    <div className={`w-full max-w-6xl h-[60vh] flex gap-8 ${activeQuestion.image ? 'justify-between' : 'justify-center'}`}>
                      {activeQuestion.image && <div className="hidden md:flex w-1/3 h-full rounded-3xl overflow-hidden bg-white shadow-sm border border-slate-100 animate-in slide-in-from-left duration-700"><img src={activeQuestion.image} className="w-full h-full object-cover" /></div>}
                      <div className={`${activeQuestion.image ? 'flex-1 max-w-4xl' : 'w-full max-w-5xl'} h-full bg-white/50 backdrop-blur-sm rounded-3xl shadow-sm border border-white/60 p-6 flex flex-col`}>
                        <div className="flex-1 overflow-hidden relative">
                          {timeLeft > 0 && <div className={`absolute top-4 right-4 z-20 ${THEMES[currentTheme].bg} text-white px-4 py-2 rounded-full font-bold shadow-lg animate-pulse flex items-center gap-2`}><TimerIcon size={20} />{timeLeft}s</div>}
                          {(sessionData.showResults === false) && <div className="absolute inset-0 bg-white/90 backdrop-blur-sm z-10 flex items-center justify-center flex-col animate-in fade-in duration-300"><div className="bg-slate-100 p-6 rounded-full mb-4"><EyeOff size={48} className="text-slate-400" /></div><p className="text-slate-500 font-bold text-xl">çµæœã¯éè¡¨ç¤ºã«ãªã£ã¦ã„ã¾ã™</p><p className="text-slate-400 text-sm mt-2">æŠ•ç¥¨ã¯å—ã‘ä»˜ã‘ä¸­ã§ã™</p></div>}
                          
                          {activeQuestion.type === 'choice' && (currentVisual === 'bar' ? <BarChartVis data={activeQuestion.votes} total={totalVotes} correctOption={activeQuestion.correctOption} isAnswerRevealed={activeQuestion.isAnswerRevealed} /> : <DonutChartVis data={activeQuestion.votes} total={totalVotes} correctOption={activeQuestion.correctOption} isAnswerRevealed={activeQuestion.isAnswerRevealed} />)}
                          {activeQuestion.type === 'ranking' && <RankingVis data={activeQuestion.votes} />}
                          {activeQuestion.type === 'wordcloud' && <WordCloudVis votes={activeQuestion.votes} isHost={true} onDelete={deleteVote} />}
                          {activeQuestion.type === 'open' && <OpenEndedVis votes={activeQuestion.votes} isHost={true} onDelete={deleteVote} />}
                          {activeQuestion.type === 'qa' && <QaVis votes={activeQuestion.votes} isHost={true} onMarkAnswered={markQaAnswered} onDelete={deleteVote} theme={currentTheme} />}
                          {activeQuestion.type === 'reaction' && <ReactionVis votes={activeQuestion.votes} />}
                          {activeQuestion.type === 'content' && <ContentVis question={activeQuestion} />}
                        </div>
                      </div>
                    </div>
                    
                    {showNotes && (
                      <div className="absolute bottom-24 right-8 w-64 bg-yellow-50 border border-yellow-200 p-4 rounded-xl shadow-lg animate-in slide-in-from-bottom-5 text-sm text-yellow-900 z-50">
                        <h4 className="font-bold mb-1 flex items-center gap-1"><StickyNote size={14}/> ç™ºè¡¨è€…ãƒ¡ãƒ¢</h4><p className="whitespace-pre-wrap">{activeQuestion.notes || "ãƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“"}</p>
                      </div>
                    )}

                    <div className="mt-8 flex gap-4 animate-in slide-in-from-bottom duration-500 fade-in z-20">
                      <button onClick={startTimer} disabled={timeLeft > 0} className={`flex items-center gap-2 px-6 py-3 rounded-full shadow-lg font-bold transition-all active:scale-95 ${timeLeft > 0 ? 'bg-slate-100 text-slate-400 cursor-not-allowed' : 'bg-white text-slate-600 hover:bg-slate-50'}`}><TimerIcon size={20} />{timeLeft > 0 ? `${timeLeft}s` : '30ç§’ã‚¿ã‚¤ãƒãƒ¼'}</button>
                      <button onClick={toggleLock} className={`flex items-center gap-2 px-6 py-3 rounded-full shadow-lg font-bold transition-all active:scale-95 ${activeQuestion.isLocked ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-white text-slate-600 hover:bg-slate-50'}`}>{activeQuestion.isLocked ? <Lock size={20} /> : <Unlock size={20} />}{activeQuestion.isLocked ? 'æŠ•ç¥¨å†é–‹' : 'æŠ•ç¥¨ç· åˆ‡'}</button>
                      <button onClick={toggleResults} className={`flex items-center gap-2 px-6 py-3 rounded-full shadow-lg font-bold transition-all active:scale-95 ${sessionData.showResults !== false ? 'bg-white text-slate-600 hover:bg-slate-50' : `${THEMES[currentTheme].bg} text-white ${THEMES[currentTheme].bgHover}`}`}>{sessionData.showResults !== false ? <EyeOff size={20} /> : <Eye size={20} />}{sessionData.showResults !== false ? 'çµæœã‚’éš ã™' : 'çµæœã‚’è¡¨ç¤º'}</button>
                      {activeQuestion.correctOption && (<button onClick={toggleAnswer} className={`flex items-center gap-2 px-6 py-3 rounded-full shadow-lg font-bold transition-all active:scale-95 ${activeQuestion.isAnswerRevealed ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-white text-slate-600 hover:bg-slate-50'}`}><Check size={20} />{activeQuestion.isAnswerRevealed ? 'æ­£è§£ã‚’éš ã™' : 'æ­£è§£ã‚’è¡¨ç¤º'}</button>)}
                      <button onClick={resetVotes} className="flex items-center gap-2 px-6 py-3 bg-white rounded-full shadow-lg text-slate-600 font-bold hover:bg-red-50 hover:text-red-600 transition-all active:scale-95"><RotateCcw size={20} />ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                    <div className="absolute bottom-4 right-4 z-30">
                       <button onClick={() => setShowShortcuts(!showShortcuts)} className={`p-2 bg-white rounded-full shadow text-slate-400 ${THEMES[currentTheme].textHover}`} title="ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ"><Keyboard size={20} /></button>
                       {showShortcuts && (
                         <div className="absolute bottom-12 right-0 bg-white p-4 rounded-xl shadow-2xl border border-slate-100 w-64 text-sm text-slate-600 animate-in slide-in-from-bottom-2 fade-in">
                           <h4 className={`font-bold mb-2 ${THEMES[currentTheme].text}`}>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</h4>
                           <div className="grid grid-cols-2 gap-y-1"><span>â† / â†’</span><span>ã‚¹ãƒ©ã‚¤ãƒ‰ç§»å‹•</span><span>F</span><span>å…¨ç”»é¢åˆ‡æ›¿</span><span>L</span><span>æŠ•ç¥¨ãƒ­ãƒƒã‚¯</span><span>H</span><span>çµæœè¡¨ç¤º/éè¡¨ç¤º</span><span>T</span><span>ã‚¿ã‚¤ãƒãƒ¼ã‚¹ã‚¿ãƒ¼ãƒˆ</span></div>
                         </div>
                       )}
                    </div>
                    {showQr && <div className="absolute inset-0 bg-white/95 z-50 flex items-center justify-center flex-col animate-in fade-in zoom-in duration-300"><div className="bg-white p-8 rounded-3xl shadow-2xl text-center border border-slate-100 max-w-sm w-full"><img src={`https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(window.location.origin + window.location.pathname + '?room=' + roomId)}`} alt="QR Code" className="mx-auto mb-6 rounded-lg" /><div className="text-3xl font-black text-slate-800 tracking-widest mb-2">{roomId}</div><p className="text-slate-500 mb-6">ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å‚åŠ </p><div className="flex flex-col gap-2"><a href={`?room=${roomId}`} target="_blank" rel="noopener noreferrer" className={`flex items-center justify-center gap-1 text-sm ${THEMES[currentTheme].text} font-bold hover:underline mb-2`}><ExternalLink size={14}/> ãƒªãƒ³ã‚¯ã‚’é–‹ã</a><button onClick={downloadQr} className={`flex items-center justify-center gap-1 text-sm ${THEMES[currentTheme].text} font-bold hover:underline mb-2`}><Download size={14}/> ç”»åƒã‚’ä¿å­˜</button><button onClick={() => setShowQr(false)} className="text-slate-400 font-medium hover:text-slate-600">é–‰ã˜ã‚‹</button></div></div></div>}
                  </div>
                </main>
                <CreateQuestionModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={saveQuestion} initialData={editingQuestion} theme={currentTheme} />
                <ToastContainer toasts={toasts} />
              </div>
            );
          }

          if (mode === 'voter') {
            if (!voterName) {
              return (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6">
                  <div className="max-w-xs w-full bg-white p-8 rounded-3xl shadow-xl border border-slate-100 text-center">
                    <div className="flex justify-center mb-4"><div className={`p-3 rounded-full ${THEMES[currentTheme].light} ${THEMES[currentTheme].text}`}><User size={32} /></div></div>
                    <h2 className="text-xl font-bold text-slate-800 mb-2">ãŠåå‰ã‚’æ•™ãˆã¦ãã ã•ã„</h2>
                    <p className="text-xs text-slate-400 mb-6">æŠ•ç¥¨æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã§ã™</p>
                    <form onSubmit={(e) => { e.preventDefault(); if(e.target.name.value.trim()) handleSetVoterName(e.target.name.value.trim()); }}>
                      <input name="name" type="text" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " className={`w-full p-3 mb-4 rounded-xl border border-slate-300 focus:outline-none ${THEMES[currentTheme].ring}`} required autoFocus />
                      <button type="submit" className={`w-full py-3 text-white rounded-xl font-bold transition-all ${THEMES[currentTheme].bg} ${THEMES[currentTheme].bgHover}`}>å‚åŠ ã™ã‚‹</button>
                    </form>
                  </div>
                </div>
              );
            }

            return (
              <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                <div className="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden flex flex-col h-[80vh] relative">
                  {activeQuestion.isLocked && <div className="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center p-8 text-center animate-in fade-in"><div className="bg-slate-100 p-6 rounded-full mb-6"><Lock size={48} className="text-slate-400" /></div><h3 className="text-2xl font-bold text-slate-800 mb-2">æŠ•ç¥¨çµ‚äº†</h3><p className="text-slate-500">ã“ã®è³ªå•ã®å—ä»˜ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚</p></div>}
                  {timeLeft > 0 && !activeQuestion.isLocked && <div className={`absolute top-16 right-4 z-10 ${THEMES[currentTheme].bg} text-white px-3 py-1 rounded-full text-sm font-bold shadow animate-pulse`}>ã‚ã¨ {timeLeft} ç§’</div>}
                  <div className="h-14 bg-white border-b flex items-center justify-between px-4">
                    <div className="flex items-center gap-2 overflow-hidden"><span className={`font-bold flex-shrink-0 flex items-center gap-1 ${THEMES[currentTheme].text}`}><AppLogo customSrc={displayLogo} size={24} /> Teddy</span><span className="text-xs text-slate-400 truncate border-l border-slate-200 pl-2 ml-1">Hello, {voterName}</span></div>
                    <div className="flex items-center gap-2"><div className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 flex-shrink-0">Room: {roomId}</div><button onClick={exitSession} className="p-1 text-slate-400 hover:text-red-500" title="é€€å‡º"><LogOut size={16} /></button></div>
                  </div>
                  <div className="flex-1 overflow-y-auto p-6 bg-slate-50 relative">
                    {activeQuestion.image && activeQuestion.type !== 'content' && <div className="w-full h-48 mb-4 rounded-xl overflow-hidden bg-slate-200"><img src={activeQuestion.image} className="w-full h-full object-cover" /></div>}
                    {activeQuestion.type !== 'content' && <h3 className="text-xl font-bold text-slate-800 mb-6">{activeQuestion.question}</h3>}

                    {activeQuestion.isAnswerRevealed && activeQuestion.correctOption && hasVotedCurrent && (
                        <div className={`mb-4 p-4 rounded-xl text-center font-bold text-white shadow-sm animate-in zoom-in ${votedQuestions.includes(activeQuestion.id) ? 'bg-slate-400' : '' }`}><p className="text-sm opacity-90">æ­£è§£ã¯...</p><p className="text-2xl mt-1">{activeQuestion.correctOption}</p></div>
                    )}

                    {sessionData.showResults && !activeQuestion.isLocked && (
                      <div className="mb-6 border-b border-slate-100 pb-6">
                        <p className="text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider text-center">ãƒ©ã‚¤ãƒ–çµæœ</p>
                        <div className="h-48 overflow-hidden rounded-xl bg-slate-50 p-2 border border-slate-200">
                           {activeQuestion.type === 'choice' && (currentVisual === 'bar' ? <BarChartVis data={activeQuestion.votes} total={totalVotes} /> : <DonutChartVis data={activeQuestion.votes} total={totalVotes} />)}
                           {activeQuestion.type === 'ranking' && <RankingVis data={activeQuestion.votes} />}
                           {activeQuestion.type === 'wordcloud' && <WordCloudVis votes={activeQuestion.votes} isHost={false} />}
                        </div>
                      </div>
                    )}

                    {activeQuestion.type === 'choice' && <div className="space-y-3">{
                       hasVotedCurrent && !activeQuestion.isAnswerRevealed
                       ? <div className="text-center py-8 text-slate-400"><CheckCircle size={48} className="mx-auto mb-2 opacity-50" /><p>æŠ•ç¥¨ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ</p></div>
                       : activeQuestion.options.map((opt) => {
                           const isCorrect = activeQuestion.isAnswerRevealed && opt === activeQuestion.correctOption;
                           const isDimmed = activeQuestion.isAnswerRevealed && !isCorrect;
                           return (
                           <button key={opt} onClick={() => !activeQuestion.isAnswerRevealed && submitVote(opt)} disabled={activeQuestion.isAnswerRevealed} className={`w-full p-4 border rounded-xl shadow-sm transition-all text-left font-medium flex justify-between items-center ${isCorrect ? 'bg-green-100 border-green-500 text-green-700' : 'bg-white border-slate-200 text-slate-700'} ${isDimmed ? 'opacity-50' : ''} ${!activeQuestion.isAnswerRevealed && !hasVotedCurrent ? `${THEMES[currentTheme].border.replace('border', 'hover:border')} hover:shadow-md active:scale-95` : ''}`}>
                             {opt}{isCorrect && <CheckCircle size={20} className="text-green-600"/>}
                           </button>
                           )
                       })
                    }</div>}
                    {activeQuestion.type === 'ranking' && <div className="space-y-3">
                       {hasVotedCurrent ? <div className="text-center py-8 text-slate-400"><CheckCircle size={48} className="mx-auto mb-2 opacity-50" /><p>æŠ•ç¥¨ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸ</p></div> : 
                       <><p className="text-xs text-slate-500">é †ä½ã‚’ã¤ã‘ã¦æœ€å¤§3ã¤é¸æŠ</p>{activeQuestion.options.map((opt) => { const idx = rankingSelection.indexOf(opt); const isSel = idx !== -1; return (<button key={opt} onClick={() => { if(isSel) setRankingSelection(prev => prev.filter(o => o !== opt)); else if(rankingSelection.length < 3) setRankingSelection(prev => [...prev, opt]); }} className={`w-full p-4 border rounded-xl shadow-sm transition-all text-left font-medium flex justify-between ${isSel ? `${THEMES[currentTheme].light} ${THEMES[currentTheme].border} ${THEMES[currentTheme].text}` : 'bg-white'}`}>{opt} {isSel && <span className={`w-6 h-6 rounded-full flex items-center justify-center text-xs ${THEMES[currentTheme].bg} text-white`}>{idx + 1}</span>}</button>); })}<button onClick={() => {submitVote(rankingSelection); setRankingSelection([]);}} disabled={rankingSelection.length === 0} className={`w-full py-3 text-white rounded-xl font-bold mt-4 disabled:opacity-50 ${THEMES[currentTheme].bg}`}>é€ä¿¡</button></>}
                    </div>}
                    {activeQuestion.type === 'wordcloud' && <form onSubmit={(e) => { e.preventDefault(); const val = e.target.word.value; if(val) { submitVote(val); e.target.reset(); } }} className="space-y-3"><input name="word" type="text" placeholder="å›ç­”ã‚’å…¥åŠ›..." maxLength={20} className="w-full p-4 rounded-xl border border-slate-300" autoComplete="off" /><button type="submit" className={`w-full py-3 text-white rounded-xl font-bold flex items-center justify-center gap-2 ${THEMES[currentTheme].bg}`}>é€ä¿¡ <Send size={18} /></button></form>}
                    {activeQuestion.type === 'open' && <form onSubmit={(e) => { e.preventDefault(); const val = e.target.text.value; if(val.trim()) { submitVote(val.trim()); e.target.reset(); } }} className="space-y-3"><textarea name="text" placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." className="w-full p-4 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 min-h-[150px] resize-none" /><button type="submit" className={`w-full py-3 text-white rounded-xl font-bold flex items-center justify-center gap-2 ${THEMES[currentTheme].bg}`}>é€ä¿¡ <Send size={18} /></button></form>}
                    {activeQuestion.type === 'qa' && (
                      <div className="space-y-6">
                        <form onSubmit={(e) => { e.preventDefault(); const val = e.target.text.value; if(val.trim()) { submitVote(val.trim()); e.target.reset(); } }} className="space-y-2"><textarea name="text" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." className="w-full p-3 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 h-24 resize-none text-sm" /><button type="submit" className={`w-full py-2 text-white rounded-lg font-bold text-sm ${THEMES[currentTheme].bg}`}>è³ªå•ã™ã‚‹</button></form>
                        <div className="space-y-3">
                          <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider">ã¿ã‚“ãªã®è³ªå•</h4>
                          {Object.entries(activeQuestion.votes || {}).sort((a,b) => (b[1].likes || 0) - (a[1].likes || 0)).map(([id, q]) => (
                            <div key={id} className={`bg-white p-3 rounded-lg border ${q.answered ? 'opacity-50' : ''} shadow-sm`}>
                              <div className="flex justify-between gap-3">
                                <div className="flex-1"><p className="text-sm font-medium text-slate-800">{q.text}</p><div className="text-xs text-slate-400 mt-1 flex items-center gap-1"><User size={10}/> {q.user}</div></div>
                                <button onClick={() => toggleQaLike(id)} className={`flex flex-col items-center justify-center bg-slate-50 ${THEMES[currentTheme].lightHover} text-slate-400 ${THEMES[currentTheme].textHover} w-10 h-10 rounded-lg transition-colors`}><ThumbsUp size={16} /><span className="text-xs font-bold">{q.likes || 0}</span></button>
                              </div>
                            </div>
                          ))}
                          {Object.keys(activeQuestion.votes || {}).length === 0 && <div className="text-center text-slate-400 text-sm py-4">ã¾ã è³ªå•ã¯ã‚ã‚Šã¾ã›ã‚“</div>}
                        </div>
                      </div>
                    )}
                    {activeQuestion.type === 'content' && (
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 mt-4">
                            {activeQuestion.image && <div className="w-full h-48 mb-4 rounded-xl overflow-hidden bg-slate-200"><img src={activeQuestion.image} className="w-full h-full object-contain" /></div>}
                            <h3 className="text-xl font-bold text-slate-800 mb-4">{activeQuestion.question}</h3>
                            {activeQuestion.options && activeQuestion.options[0] && <p className="text-slate-600 whitespace-pre-wrap">{activeQuestion.options[0]}</p>}
                        </div>
                    )}
                    {activeQuestion.type === 'reaction' && <div className="grid grid-cols-3 gap-3 mt-8">{['like', 'heart', 'smile'].map(type => <button key={type} onClick={() => submitVote(type)} className={`aspect-square ${THEMES[currentTheme].light} rounded-2xl flex items-center justify-center ${THEMES[currentTheme].text} active:scale-90 transition-all`}>{type==='like'?<ThumbsUp size={32} />:type==='heart'?<Heart size={32} />:<Smile size={32} />}</button>)}</div>}

                    {sessionData.activeQuestionId && <FloatingReactions votes={activeQuestion.votes} />}
                  </div>
                </div>
                <ToastContainer toasts={toasts} />
              </div>
            );
          }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>